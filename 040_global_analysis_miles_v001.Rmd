---
title: "060_Global Variable Analysis"
author: "by Craig W. Slinkman"
date: "7/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load_packages}
#
#######################################################################
# This code chunk loads the thr R packages needed for specific 
# functionality
#######################################################################
#
suppressMessages( library( tidyverse ))
suppressMessages( library( lubridate ) )
suppressMessages( library( flextable ) )
suppressMessages( library( officer ) )
suppressMessages( library( cowplot ) )
suppressMessages( library( boot ) )
#
```

```{r set_constants}
#
#######################################################################
# This code chunk sets constants for this R Markdown document.
#######################################################################
#
DAYS <- 180                            # Assumed number of days in 6 months
#
VARIABLE <- "miles"                    # Variables to be analyzed
#
VLABEL   <- "Miles walked"             # Label for variable
       
REPS <- 1025                           # Replications for bootstrap
#
```





```{r load_functions}

#######################################################################
# This code chunk loads the functions in the orer they are called.
#######################################################################

source( 'functions/compute_dates_v003.R' )      # Compute dates for display and
                                                # analysis
          

source('functions/display_period.R')            # Display analysis 
                                                # period dates ...
 
source('functions/get_walks_v004.R')             # Read all walks ...


source('functions/search_v001.R')               # Finds column position of
                                                # variable ...

source('functions/plot_distribution.R')        # Draws a historgram and density                                                      # diagram 
                                            

source('functions/plot_qq_norm.R')             # Plots normal QQ plot     
                                               # to assess normality
                                               # Used to bootstrap the sample
                                               # mean

source("functions/boot_statistics.R")          # Compute bootstrap distribution
                                               # of mean and distribution

source("functions/display_bootstrap_summary.R")    # To display default bootstrap
                                                   # statustics

source("functions/display_confidence_intervals.R") # Displays a flextable containing 
                                                   # the various bootstrap
                                                   # intervals

source("functions/diagnose_bootstrap_statistics.R") # Used to graphicall diagnose
                                                    # the bootstrap distributions of
                                                    # mean and standard deviation ...

source("functions/simulate_pi_v001.R")              # Used rto simulated predictions
                                                    # to enable us to construct
                                                    # prediction interva;s ...
``` 

```{r read_walks}

##############################################################################
# This code chunk reads the last 6 months walks both days that were 
# walked and days that hade missed walks.  The days with missing
# walks older than 180 days are filtered out.
##############################################################################


file_path <- file.path( "data", "walks.csv" )

all_walks <- get_walks( file_path)              # Read walks into tibble 

six_months_walks <- 
    all_walks %>% 
        filter( walked == 1 ) %>% 
        filter( date > as.Date( today() - 180 ))


```


## Univariate analysis for $miles$ walked

The following is an analysis miles walked variable.

```{r extract_variable_vaalues}


variable_names <- colnames( six_months_walks )       # Get vaeiable names ...# 
#
p <- search( key="miles", variable_names )           # Got variable columns number

if( is.na(p)) stop(                                # Ensure variable columns was
    paste("Unable to find variable", VARIABLE))    # found ...
#
values <- six_months_walks[[p]]
#
```




```{r draw_variable_histogram}

plot_distribution( values, "Miles", "Density Histogram and plot" )

```

### Normal antiquate-quantile plot of miles

```{r draw_variable_qq_plot}

plot_qq_norm( values, variable_name =VLABEL )

```


#### Bootstrap estimate of the population mean

```{r build_compute_statistics_function}
###############################################################################
# Define function to compute the bootstrap sample statistics: the sample mean
# and the sample standard deviation
###############################################################################

compute_statistics <-                             # Compute the bootstrap
    function( y, index ){
    y <- y[index]
    ybar <- mean( y )
    ystd <- sd( y )
    c( ybar, ystd ) 
    }


```


```{r boot_variable}

###############################################################################
# Bootstrap the sample mean and standard deviation and the display the
# bootstrap simmary statistics 
###############################################################################
#

boot.out <- boot( values,
                     compute_statistics,
                     R=REPS )

display_bootstrap_summary( boot.out )

```

### Bootstrap diagnostic plots

```{r plot_bootstrap_disgnostic_plots}
###############################################################################
# Draw density histogram and plot of bootstrapped sample
###############################################################################

ybar         <- boot.out$t[,1]
std          <- boot.out$t[,2]
bsample      <- tibble( ybar,std )


p1a <- 
    plot_distribution( ybar, 
                       "Means distribution",
                       "Bootstrap Histogram" )

p1b <- plot_distribution( std,
                          "Standard deviation distribution",
                          "Bootstrap Histogram")

p1c <- 
    plot_qq_norm( ybar, 
                R = 100,
                variable_name="Means",
                plot_title = "Normal QQ plot")

p1d <- 
    plot_qq_norm( std, 
                R = 100,
                variable_name="Standard deviations",
                plot_title = "Normal QQ plot")
```


```{r plot_grid}
plot_grid( p1a, p1b, p1c, p1d )
```


```{r plot_two_bootstrap_means_vs-std}
ggplot( bsample,
        aes(x=ybar, y=std )) +
    geom_point() +
    geom_density_2d( stat = "density2d",
                     mlineend = "butt", 
                     linejoin = "round",
                     linemitre = 10, 
                     na.rm = TRUE, 
                     how.legend = TRUE,
                     inherit.aes = TRUE,
                     color="red",
                     size=1.25 ) +
    xlab( "Bootstrap means") +
    ylab( "Bootstrap standard deviations") +
    theme_cowplot()
#
```

#### Bootstrap 95% confidence intervals for the mean and standard deviation of miles walked

```{r display_ci_mean}
#
interval_types <-  c( "basic",                   # Define types of confidence
                      "norm",                    # intervals to compute ...
                      "perc" )

boot.ci( boot.out,                               # Compute confidence intervals for
         index=1,                                # the mean ...
         type = interval_types )

boot.ci( boot.out,                               # Compute confidence intervals for
         index=2,                                # the standard deviation ...
         type = interval_types )
```

### Predictions

In this section of this report we use simulation to draw a prediction distribution that we will use to construct prediction intervals.   We draw a density histogram and normal quantile-quantile plot to assess normality.  After this we will compute the quantiles and draw an empirical distribution function.

```{r simulate_predictions}
#
predictions <- simulate_predictions( bsample  )

p2a <- plot_distribution( predictions,
                          "prediction",
                          "Predictive distribution")
p2a

p2b <- plot_qq_norm( predictions,
                     variable_name="prediction")


#
```

#### Assessing the bias of the prediction distribution

Here we assess the degree of bias do to the bootstrap and simulation.  

```{r assess_prediction_bias}
#
mean_prediction <- mean( predictions )
mean_value      <-  mean( values )
bias            <- mean_prediction - mean_value
percent_bias    <- round( 100 * bias / mean_value, 1 )
std             <- sd( predictions)

tibble( mean_prediction, 
        mean_value, 
        bias,
        percent_bias,
        std) %>% 
    
    flextable() %>% 
        set_header_labels( mean_prediction = "Mean\nPrediction\n",
                           mean_value       = "Sample\nMean\n",
                           bias             = "Bias\n \n",
                           percent_bias     = "Percent\nbias",    
                           std              = "Prediction\nStandard\ndeviation") %>% 
        fontsize( size=14, part="all")
#

```

The value of the bias is small when compared to the mean and standard deviation so we can ignore it.


#### Diagnostic plots of prediction distribution

We draw a density histogram with a density plot and a normal quantile-quantile plot to assess the normality of the prediction distribution.  If the distribution appear to be normally distributed then we can use the normal distribution to assess the the prediction intervals.

```{r plot_prediction_distribution_diagnostics}
#
p2a
#
p2b
#
```

#### Compute prediction intervals 

G. E. P Box once recommended that one should give more one confidence interval to give the user an idea of the degree of risk to the user of the confidence intervals.  We do that here computing the 50%, 0.75, 90%, 95%, and 99% confidence intervals.  

```{r compute_confidence_intervals}

probability <-  c( 0.50, 0.75, 0.90,              # Define probabilities for
                   0.95, 0.98, 0.99 )             # prediction intervals.

z  <- abs( qnorm(  ( 1 - probability )/ 2,        # Compute normal quantiles 
                    lower.tail = TRUE ) )         # for prediction intervals.

forecast <- rep(  round( mean_value, 2), 
                  length( z ))

error_bound <- round( std * z, 2)                # Compute prediction interval
                                                 # error bould.

lower       <- mean_value - error_bound          # Compute ulower and upper 
upper       <- mean_value + error_bound          # bounds.

percent     <- round( 100 * probability  )       # Convert ecimal to precentage for                                                    # graphics ...

predictions <-                                  # Build tibble for ggplot2 ...
    tibble(percent,    
           lower,
           forecast,
           upper )

           
        
```

### Predictions and prediction intervals

```{r format_probability_statement_number}
l <- round( predictions[[4]][2], 2 )
u <- round( predictions[[4]][4], 2 )
```


Here we display the prediction intervals for **`R VLABEL`**.  Unlike classical confidence intervals these are true probability statements.  


```{r display_predictions}

digits_0 <- "Probability"
digits_2 <- c( "Lower",
               "Forecast",
               "Upper" )

predictions %>%
    rename( "Probability"= "percent",
            "Lower"      = "lower",
            "Forecast"   = "forecast",
            "Upper"      = "upper" )  %>%
        flextable() %>% 
            colformat_num( col_keys = "Probability",
                           digits = 0,
                           suffix="%" ) %>% 
            colformat_num( col_keys = digits_2,
                        digits = 2,
                        big.mark = "," ) %>% 
            fontsize( size = 14, 
                       part = "all" )

```
 
 
 
We interpret the above tables as follows.  On a randomly selected walk the mean walking distance is `r predictions$forcast[4]` miles.  There is a 95% probability that the walk will be between `r predictions$lower[4]` and `r predictions$upper[[4]]`  miles.  

This may seem like a wide interval. This is due to some short walks I took six months ago which inflated the standard deviation of the error.  The length of different routes alks varies widely and this also increases the standard deviation.