---
title: "Missing values imputation using linear regression."
author: "by Craig W. Slinkman"
date: "11/22/2019"
output: html_document
---

## My Walks Analysis
## Imputation of the missing values of $ksteps$ 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries 
I use a source file to load packages that I use frequently.  The source file is
located in my Rsource library.


```{r load packages}
#
source( 'functions/load_libraries_v003.R' )      # Load R packages ...
#
```

```{r load_functions}
#
source('~/R-Projects/Rsource/compute_dates_v004.R')    # Computes useful dates ...
source( 'functions/get_walks_v005.R' )                 # Load function to read ...
                                                       # walks ...
source('~/R-Projects/Rsource/plot_diagnostics_v001.R') # Plot diagnostics ...
#
```

```{r compute_dates}
#
dates <- compute_dates()                               # Compute dates lilely to be
                                                       # used most often ...
#
```
              
### Analysis dates 

This analysis is based on date from **`r dates$date_180_days_ago`** through **`r dates$date_000_days_ago`**.

## Read data 

```{r read_data}

all_walks <- get_walks()                         # Get walks ...
#
```

### Number of days in file.

There are `r dim( all_walks )[1]` days recorded in the $walks.csv$ file. 

Note that the entries in the walk file are days not walks.  This is to allow us to record days when there is no walk taken. 

## Getting all walks less than 180 days old 

```{r filter_walk}

recent_walks <-                                  # Get last 180 days walks ...
    all_walks %>% 
        filter( date >  
                as.Date( dates$date_180_days_ago + 1) )
```

There are `r dim(recent_walks)[1]` days in the recent walks.  After 180 days this number should be 180 or 179 if a walk has not been taken on the last day.

## Remove days with no walks

```{r remove_no_walks}
#
no_walks <-                                      # Get days with no walks ...
    recent_walks %>% 
        filter( walked == 0 )

recent_walks <- 
    recent_walks %>% 
        filter( walked == 1 )
#
```

## Remove row where $miles$ is missing

```{r remove_missing_miles}
#
recent_walks <-                                  # Filter out days where 
    recent_walks %>%                             # is missing 
        filter( !is.na(miles) )

```


## Determine days where $ksteps$ is missing 

Here we partition the recent_walks into two subsets.  Days where the variable $ksteps$ is missing and days where $ksteps$ is not missing.

```{r partion_by_missing_ksteps}

missing <-                                       # Make a tibble that contians rows
    recent_walks %>%                             # where ksteps is missing
        filter( is.na(ksteps))

not_missing <-                                   # Make a tibble that contians rows
    recent_walks %>%                             # where ksteps is not missing ...
        filter( !is.na(ksteps))

```


### Scatterplot of $ksteps$ versus $miles$

```{r draw_scatterplot( ksteps_miles)}
#
ggplot( not_missing,
        aes( x=miles, y=ksteps, color=environment)) +
    geom_point() +
    geom_smooth( method="lm",
                 color="black" ) +
    geom_smooth( method="loess",
                 color="red ")
```

## Fit model  $OLS_1: ksteps ~ miles$


```{r fit_ols_1}
#
ols_1 <- lm( ksteps ~ miles, 
           data=not_missing )
tidy( ols_1 ) %>% 
    flextable( ) %>% 
    colformat_num( j=2:4,
                   digits=3 ) %>% 
    colformat_num( j=5, 
                digits = 4 ) %>% 
    add_header_lines( values ="ksteps ~ miles", 
                         top = TRUE) %>% 
    merge_at( i = 1, j = NULL, part = "header") %>% 
    fontsize( size=14,
              part="all" )  %>% 
    fontsize( size = 14, part="all" ) %>% 
    theme_box() %>% 
    autofit()
#
glance_1 <- bind_cols( data.frame( ols = 1 ),
                    glance( ols_1 ))
#
```
           
## Fit model $OLS_2: ksteps = environment + miles$

```{r fit_ols_2}
#
ols_2 <- lm( ksteps ~ environment + miles,
             data = not_missing )
#
tidy( ols_2 ) %>% 
    flextable( ) %>% 
    colformat_num( j=2:4,
                   digits=3 ) %>% 
    colformat_num( j=5, 
                digits = 4 ) %>% 
    add_header_lines( values ="ksteps ~ environment + miles", 
                         top = TRUE) %>% 
    merge_at( i = 1, j = NULL, part = "header") %>% 
    fontsize( size=14,
              part="all" )  %>% 
    fontsize( size = 14, part="all" ) %>% 
    theme_box() %>% 
    autofit()
#
glance_2 <- bind_cols( data.frame( ols = 2 ),
                    glance(ols_2 ))
#
```

## Fit model ols_3: $ksteps = miles * environment$ 

```{r filt_model_3}
#
ols_3 <- lm( ksteps ~ miles * environment,
             data = not_missing )
#
tidy( ols_3 ) %>% 
    flextable( ) %>% 
    colformat_num( j=2:4,
                   digits=3 ) %>% 
    colformat_num( j=5, 
                digits = 4 ) %>% 
    add_header_lines( values = "ksteps ~ miles * environment", 
                         top = TRUE) %>% 
    merge_at( i = 1, j = NULL, part = "header") %>% 
    fontsize( size=14,
              part="all" )  %>% 
    fontsize( size = 14, part="all" ) %>% 
    theme_box() %>% 
    autofit()  
#
glance_3 <- bind_cols( data.frame( ols = 3 ),
                    glance(ols_3 ))
#
```

## Model OLS 4:$ksteps = route + miles$  

```{r filr_ols_3}
#
ols_4 <- lm( ksteps ~ route + miles,
             data = not_missing )
#
tidy( ols_4 ) %>% 
    flextable( ) %>% 
    colformat_num( j=2:4,
                   digits=3 ) %>% 
    colformat_num( j=5, 
                digits = 4 ) %>% 
    add_header_lines( values = "ksteps ~ miles * environment", 
                         top = TRUE) %>% 
    merge_at( i = 1, j = NULL, part = "header") %>% 
    fontsize( size=14,
              part="all" )  %>% 
    fontsize( size = 14, part="all" ) %>% 
    theme_box() %>% 
    autofit()  
#
#
glance_4 <- bind_cols( data.frame( ols = 4 ),
                    glance(ols_4 ))
    
```


## Compare_models

```{r compare_models}
#
comparison <- bind_rows( glance_1,
                         glance_2,
                         glance_3,
                         glance_4 )
comparison %>% 
    flextable(  ) %>% 
    colformat_num( j = 2:4, 
                   digits = 3 ) %>% 
    colformat_num( j = 5,
                   digits =2 ) %>% 
    colformat_num( j = 6, 
                  digits = 4 ) %>% 
    colformat_num(  j= 8:11,
                   digits = 2 ) %>% 
    fontsize( size=14, part="all" ) %>% 
    theme_box() %>% 
    autofit()
#
```

We the selected fitted model is $ols_4$.

## Make predictions

```{r impute values}
#
imputed_values <- predict( ols_4, 
                           newdata=missing )

tibble( miles = missing$miles,
        ksteps = imputed_values ) %>% 
    ggplot( aes( x=miles, y=ksteps )) +
        geom_point()

missing$ksteps <- imputed_values

imputed_days <- bind_rows( not_missing, 
                            missing,
                            no_walks ) %>% 
        arrange( id )

```


## Save walks data

```{r}
save( imputed_days, 
         file="data/imputed_days.rds",
         ascii = FALSE )
```

