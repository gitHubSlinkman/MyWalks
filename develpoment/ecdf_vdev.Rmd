---
title: "Explore Cummulative Distribution function with confidence intervals"
author: "by Craig W. Slinkman"
date: "10/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load libraries ...

```{r load_packages}
#
source('~/R-Projects/MyWalks4/functions/load_libraries_v001.R')
load_libraries()
#
```
on
### Load functions

```{r load functions}
#
source('~/R-Projects/MyWalks4/functions/compute_dates_v03.R')
source('~/R-Projects/MyWalks4/functions/get_walks_v03.R')
source('~/R-Projects/MyWalks4/functions/search_v001.R')
source('~/R-Projects/MyWalks4/functions/extract_varianble_v001.R')
source('~/R-Projects/MyWalks4/functions/compute_ecdf_v001.R')
#
```

### Compute dates

```{r computed_dates}
dates <- compute_dates()
dates
```




### Get and filter walks

We read the walks and filter to the last 180 days and keep only days where walks are actually made.

```{r get_and_filter_walks}
#
file_path <- "~/R-Projects/MyWalks4/data/walks.xlsx"
all_walks <- get_walks( file_path )

walks <- 
    all_walks %>% 
        filter( date > dates$date_180_days_ago ) %>% 
        filter( walked == 1 )
#
```

### Extract variables

```{r extract_variables}
#
##############################################################################
# Extract missing variables from waks tibble and remove all missing values
##############################################################################
#
miles  <- extract_variable( "miles",  walks )                    
ksteps <- extract_variable( "ksteps", walks ) 
hours  <- extract_variable( "hours",  walks )
mph    <- extract_variable( "mph",    walks )
pace   <- extract_variable( "pace",   walks )
gain   <- extract_variable( "gain",   walks )
kcal   <- extract_variable( "kcal",   walks )
#
```

### Compute empirical cumulative distribution function

```{r compute_cdf}
ecdf_miles <- compute_ecdf( miles )

```

### Plot empirical distribution distribution functions

```{r plot_emirical_distribution_functions}

ggplot( ecdf_miles,
        aes( x= x, y=ecdf)) +
    geom_step( color="black" ) +
    xlab( "miles walked" ) +
    ylab( "Empirical cummulative distribution") +
    theme_cowplot()

```

### Add confidence bounds to the emirical cummualtive distribution

We must first compute a bound on the function which is designayed by $\epsilon$.
Thgis is computed using:

$$\epsilon = \sqrt{ \frac{1}{2n} log{\frac{2}{\alpha}}}$$

We do this below:

```{r compute_emsilon_for_miles}

n <- length(miles)                               # Obtain sample size
#
alpha <- 0.05                                    # Specify alpha 

epsilon <- sqrt( 1/ (2*n)*log(2/alpha))          # compute espsilon for the 
                                                 # miles data
#
epsilon <- sqrt( 1 /(2 * n) * log(2/alpha))      # Compute epsiloin
```

For the distribution of miles walked the value of $\epsilon$ is

$$epsilon = `r round( epsilon, 4)`$$

We now compute the lower bounds of the confidence interval for all values of the variable $x$ using the following equation

$$L(x) =max( \hat{F}_n -\epsilon, 0 )$$

for all values of $$x.  Recall that the emprical cumulative distribution is in
the R tibble $emcdf$ tibble.  Thre code fo this is given in the code chunk below:

```{r compute_cdf_ci_bounds}
#
ci_lower <-  ecdf_miles$ecdf - epsilon           # Compute upper interval
ci_upper <-  ecdf_miles$ecdf + epsilon           # Compute lower interval

ci_lower[ci_lower<0]  <-  0
ci_lower
ci_upper[ci_upper>1]  <- 1
ci_upper

ecdf_miles <- add_column( ecdf_miles, ci_lower )
ecdf_miles <- add_column( ecdf_miles, ci_upper )
ecdf_miles
```


```{r plot_ecdf_with_confidence_intervals}

vname <- "Miles walked"
title <- "Emprical distribution function for"
title <- paste( title, vname )

y_breaks <- seq( from=0.0, to=1.0, by=0.10 )
y_labels <- sprintf( "%3.1f", y_breaks )

xmin <- floor( min( ecdf_miles$x))
xmax <- ceiling ( max( ecdf_miles$x ))



ggplot( ecdf_miles,
        aes(x=x, y=ecdf)) +
    geom_step( color="black" ) +
    geom_step( aes( x=x, y=ci_lower),
               color="purple" ) +
    geom_step( aes( x=x, y=ci_upper),
               color="purple" ) +
    scale_y_continuous( breaks = y_breaks,
                        labels = y_labels ) +
    xlab( TeX("$x$") ) +
    ylab( TeX("$F_n(x)$") ) +
    ggtitle( title ) +
    theme_cowplot(  )


```


