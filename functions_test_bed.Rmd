---
title: "Test bed for new functions"
author: "Craig W. Slinkman"
date: "4/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the test bed for the new functions for the **MyWalks** project.  

I have decided to define all my functions on a single source file to make development and maintenance simpler.

### load packages

In the following chunk we load the required library functions for this project.

```{r load_packages}

###########################################################################
# Load required R-packkages ...
###########################################################################

 source('~/R-Projects/MyWalks/functions/load_packages.R')


###########################################################################
# load our defined functions ...
##########################################################################

source('~/R-Projects/MyWalks/functions/get_day_routes.R') 
source('~/R-Projects/MyWalks/functions/find_max_frequency.R')
source('~/R-Projects/MyWalks/functions/plot_bar_chart.R')
source('~/R-Projects/MyWalks/functions/convert_hhmm_to_decimal.R')
source('~/R-Projects/MyWalks/functions/plot_distribution.R')
source('~/R-Projects/MyWalks/functions/plot_qq_norm.R')
source('~/R-Projects/MyWalks/functions/diagnose_linearity.R' )
source('~/R-Projects/MyWalks/functions/diagnose_heteroskedasticity.R')
source('~/R-Projects/MyWalks/functions/compute_diagnostics.R')
source('~/R-Projects/MyWalks/functions/compute_parametrics.R')

```


### Set cowplot to be  the  default theme
```{r set_owplot}
theme_set( theme_cowplot())
```



### get_days()  test

The **get_days()** function should return a tibble of my walking data saved on a Microsoft Excel spreadsheet called **days.xlsx**.  

```{r test_get_days}
day_routes <- get_day_routes() # Test get days ...
day_routes                     # Returna a tibble of the day_routes ...
```


### plot_bar_walks()

```{r test_plot_bar_walks}

walked <-                              # Extract walked from
    day_routes %>%                     # day_routes
        select( walked )

walked = ifelse( walked == 0,          # Convert walked codes from binary
                 "Did not walk",      # to character for bar chart ...
                 "Walked")

scale <- seq( from = 0,                # Create breaks and label scales ...
              to = 375, 
              by = 10 )
            
plot_bar_chart( walked,
                variable_name = "Walked?",
                plot_title = "Days walked and not walked",
                frequency_scale = scale )
                
```

### Hardware-Software_user error

In this section we determine all the error that lead to data loss.

```{r list errors}
failure_reason <- 
    day_routes %>%
     filter( walked == 1 & 
             gps_failure == 1 ) %>% 
    select( failure_reason )

scale <- seq( from = 0, to = 8, by = 2 )

plot_bar_chart( failure_reason,
                variable_name = "Failure reason",
                plot_title = "Reasons for data loss",
                bar_width = 0.25,
                fill_color = "red", 
                frequency_scale = scale )   
    
    
```


### plot_bar_missed_reasons() test

```{r test_bar_missied_reasons}

missed_reason <- 
    day_routes %>% 
        filter( walked == 0 ) %>% 
            pull( missed_reason )

    plot_bar_chart( missed_reason, 
                    "Reasons for missing g walk",
                    "Distribution of reasons for missing walk" )
 

    

```

### test_convert_hhmm to_decimal

We are going to covert from hh:mm to hh.dd.

```{r test_convert_hhmm to decimal }

###########################################################################
# Below we extract the start times and element observations when the start # time was not record in day_routes
##########################################################################

start_times <-                                 # Extract start times from 
    convert_hhmm_to_decimal( day_routes )      # routes ....
 
 start_times <- start_times[ start_times > 0 ] # Eliminate observations when
                                               # zero start_times ...
 plot_distribution( 
     start_times,
     "Walk started times",
     "Distribution of walks starting times times" )
 
```

###  Test weather conditions

In this code we draw a bar chart of the weather conditions for each day.

```{r draw_barchart_of_weather}

###########################################################################
# In thiis code chunk we draw a bar chart of the weather conditions.
###########################################################################


###########################################################################
# We tbulate the sky condition to find the weather condition that occurs
# most often.  This will be a flipped barchart with lots of categories.
# Therefore we not use the function and will code it here.
###########################################################################

###########################################################################
# Exctract the sky variable.
###########################################################################

variable <- 
    day_routes %>%                        
        filter( !is.na( sky )) %>% 
            arrange( desc( sky )) %>% 
                select( sky ) 
            
###########################################################################
# Form a tibble and  to pass to ggplot.
###########################################################################

df <- tibble( variable )

############################################################################ Determine maximum frequency to allow us to add snapce for numerical
# frequencies to the right of the bars.
###########################################################################

max_frequency <- find_max_frequency( df )

############################################################################ Build tibble and send to ggplot.
###########################################################################

plot_bar_chart( variable,
                "Weather conditions",
                "Distribution of weather conditions" ) +
    theme(axis.text.x = 
              element_text(angle = 45, 
                           vjust = 1,
                           hjust=1))


   
    

    
```

### Plot the distribution walk temperatures

```{r plot_walk_termperatures}

temps <- 
    day_routes  %>% 
    pull( temp )

plot_distribution( temps,
                "Walling temperatures (Fahrenheit)",
                "Walking Temperatures Distribution" )

```

### Plot the distribution of relative humidity

```{r plot_distribution_humidity}

###############################################################################
# Plot the histogram and density plot od the relrive humidity.
###############################################################################

rh <-                                 
    day_routes %>% 
        pull( rh )

plot_distribution( rh,
                   "Relative humidity",
                   "Relative Humidity Distribution")

```

### Draw scatter plot of relative humidity versus walk temperature

```{r draw_scatter_plot_of rh_versus_temp}

day_routes %>%
    filter( !is.na(temp) & 
            !is.na(rh) & 
                !is.na( conditions ))  %>% 
    rename( "Conditions" = "conditions" ) %>% 
        
    
        ggplot( aes( x = temp, y = rh, color = Conditions  )) +
            geom_point( size = 2 )
        
```
## Shoes walked in
We draw a bar plot of the shoes used.

```{r draw_bar_plot_shoes}

walks <-
    day_routes %>% 
    filter( walked == 1)
    
shoes <- 
    walks %>% 
        pull( shoes )

plot_bar_chart( shoes,
                "Shoes worn",
                "Distribution of shoes worn during walk ")
        

```




## Miles walked

```{r plot_distribution_of_miles }

miles <- 
    day_routes %>% 
     filter( walked == 1 ) %>%
     pull( miles )

plot_distribution( miles,
                   "Miles walked",
                   "Distribution of miles walked" ) 

plot_qq_norm( miles,
              variable_name = "miles walked",
               plot_title = "Miles normal qq plot of miles" )
              

```

## Distribution of steps (000's) walked 

```{r plot_distibutiin_of_ksteps}

variable <- 
   day_routes %>% 
        filter( walked == 1 ) %>% 
            pull( steps )

plot_distribution( variable,
                   variable_name = "Steps walked",
                   plot_title = "Distribution of steps walked" )

plot_qq_norm( variable,
              variable_name = "Thousand steps walked",
              plot_title = "Normal QQ plot of thousand steps walked")  
              

```

plot_qq_norm( variable,
              variable_name = "Thousand steps walked",
              plot_title = "Normal QQ plot of thousand steps walked")  
              
              
### Investigation of the relationship between $miles$ and $steps$  

We start with a scatterplot of the steps versus the miles walked.

```{r draw_scatterplot_steps_versus_miles}

complete_data  <-  
    walks %>% 
        filter( is.present( miles ) &
                is.present( steps )   )
    



ggplot( complete_data,
        aes( x = miles,
             y = steps )) +
    geom_point( na.rm = TRUE )  +
    geom_smooth( method = "lm",
                 na.rm = TRUE,
                 se = FALSE ) +
    geom_smooth( mehtod = "loess",
                 color = "green",
                 se = FALSE )
    
```


### Model fit summary 

```{r fit_fitted_model_model}

###########################################################################
# We will only use data where both the the miles and steps are both 
# preseent in the data.
###########################################################################

is.present <- function( x ){
    !is.na( x )
}

fit <- lm( steps ~ miles,
           data = complete_data )

glance( fit ) %>% 
    select( r.squared,
            sigma,
            statistic,
            p.value,
            df,
            df.residual ) %>% 
                flextable() %>% 
                    width( j = 1:6, 1.00 ) %>% 
                    colformat_num( j = 1:4,
                                   digits = 4 ) %>% 
                    set_header_labels( 
                        r.squared   = "R-squared",
                        sigma       = "Estimated\nsigma",
                        statistic   = "F-statistic",
                        p.value     = "p-value",
                        df          = "Model\ndf",
                        df.residual = "df\nresiduals" )
```
 
### Regression coefficient summary 

```{r make sunnari se_regression_coefficients}

tidy( fit ) %>% 
    flextable() %>% 
        width( j = 1:5, 1.00 ) %>% 
        colformat_num( j = 2:5,
                       digits = 4 )  %>% 
        set_header_labels( term      = "Term",
                           estimate  = "Estimated\ncoefficient",
                           std.error = "Standard\nerror",
                           statistic = "t statistic",
                           p.value   = "p-value" )

```

### Diagnostic checks

This section performs graphical diagnostic checks.

### Graphical check for linearity

```{r define_assess_linearity}

###########################################################################
# The function called below draws a scaterplot of the residuals versus
# fitted values.  Its major purpose is to check the linearity assumption
# although it can be used to discover potential outliers and # heteroskedasticity. 
###########################################################################

diagnose_linearity( fit )

```

### Diagnosing heteroskedasticity

```{r diagnose_heteroskedasticity}

###########################################################################
# The function called is used to draw a scatterplot of the square root of
# the aboslute value of the residuals.  If the variance is approxumately
# The smoothed line should be roughly horizontal.  Any other shape 
# indicates that the variance is not homoskedastic.
###########################################################################

diagnose_heteroskedasticity( fit )

```

## Normal Quantile-Quantile plot of the residuals

This plot is used to assess the normality of the residuals which are the estimators of the underlying error terms.

If the quantile-quantile plot is within the simulated error bounds then we can't conclude that the residuals are not normally distributed.

A normal quantile-quantile plots the observed data quantiles versus the quantiles for a standard normal distribution.  If the sample data is drawn from a normal distribution then the intercept value of the line is an estimate of $\mu$ and the slope of the line is an estimated of the standard deviation $\sigma$.

If the plot gives a straight line then we find no evidence on non-normality.  

If the line is not straight then we find evidence of non-normality. If the quantile-quantile plot strays outside the simulated error bound then we conclude that the residuals and probably the error terms are not normally distributed.

The normal quantile-quantile plot can also be used to detect heteroskedasticity and outliers.

```{r assess_non-normality}

plot_qq_norm( variable = residuals( fit ),
              variable_name = "Residuals",
              plot_title = "Normal QQ plot" )
```


### Numerical diagnostics 

There are several observations that may be either outliers or influential observations.  R provides tools to access statistics to help us evaluate the results of our regression.

We started by computing the regression diagnostics below.

```{r compute_regression_diagnostics}

diagnostics <- compute_diagnostics( fit )

```

### Residual outliers

```{r build_dainostic report}

##########################################################################
# Jpoin walk and diagnostiocs by by case nubmber.
##########################################################################

source <- 
        complete_data %>% 
            mutate( walked_date <- as_date( date_time))
                

diagnostic_report <- 
    bind_cols( source,
                diagnostics )

source <-         
    complete_data %>% 
        mutate( walked_date = as_date( date_time)) %>% 
        select( case,
                walked_date,
                route,
                miles,
                steps )
    
report <- bind_cols( source,
                     diagnostics )

###########################################################################
# Specify the sample sample size(n), the number of predictor variables(p), 
# the model segrees of freedom(dfm), and the degrees of freedom for 
# error (dfe).
###########################################################################

n   <- dim( complete_data )[1]
p   <- 2
dfm <- 2
dfe <- n - 2

###########################################################################
# We set the parameters used to identify the unfluential observations, the
# outliers in the residuals, and the highly influential data points.
###########################################################################

RSTUDENT   <-  3.00                         # Criteria for outliers ...
HATVALUES  <-  3.00 * sqrt( p / n  )        # Criteria for high hat 
                                            # values
COVRATIO   <-  c( 1 - 3 * p / n,            # Criteria of covariance  
                  1 + 3 * p / n )           # ratio
DFFITS    <- 3 / sqrt( n )                  # Criteria for fir deletion
                                            # statistic
D2         <- 9 / n                         # Criteria dor Cooks 
                                            # distance measure  


report %>% 
    flextable() %>% 
        width( j = 2,    width = 1.00 ) %>% 
        width( j = 3,    width = 2.00 ) %>%
        width( j = 6:10, width = 1.00 ) %>% 
    colformat_num( j = 4, digits = 2 ) %>% 
    colformat_num( j = 5, digits = 3 ) %>% 
    colformat_num( j = 6:10, digits = 4 ) %>% 
    set_header_labels( case        = "Obs",
                       walked_date = "Date",
                       route       = "Route",
                       miles       = "Miles",
                       steps       = "Steps(k)",
                       rstudent    = "RStudent",
                       hats        = "Hats",
                       covratio    = "Covariance\nratio",
                       dffits      = "DFFITS", 
                       d2          = "Cooks\ndistance") %>% 
    align( i = 1, 
           j = 1:10, 
           align = "left", part = "header") %>%
    color( ~ abs( rstudent ) > RSTUDENT,
            ~ rstudent , color = "red" ) %>%  
    bold( ~ abs( rstudent ) > RSTUDENT,
          ~ rstudent, bold = TRUE ) %>% 
    color( ~ hats > HATVALUES,
           ~ hats, color = "organge ") %>% 
     bold( ~ hats > HATVALUES,
          ~ hats, bold = TRUE ) %>% 
    color( ~ covratio > COVRATIO,
           ~ covratio, color = "blue" ) %>% 
    bold( ~ covratio > COVRATIO[1] | covratio > COVRATIO[2],
          ~ covratio, bold = TRUE ) %>%
    color( ~ dffits > DFFITS,
           ~ dffits, color = "red" ) %>% 
    bold( ~ dffits > DFFITS,
          ~ dffits, bold = TRUE ) %>%
    color( ~ d2 > D2,
           ~ dffits, color = "red" ) %>% 
    bold( ~ d2 > D2,
          ~ dffits, bold = TRUE ) %>%
    theme_box()
                      
   
        
       
```






